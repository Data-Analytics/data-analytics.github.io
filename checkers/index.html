<!DOCTYPE html>
<!--------------------------------------------------------------
 Name:        data-analytics.github.io
 Purpose:     Data visualisation and analytics examples 
 Author:      sushanth
 Created:     28-01-2016
 Modified:    21-09-2016
 Copyright:  (c) sushanth 2016
 Licence:     protected(not suppose to se it directly)
---------------------------------------------------------------->
<meta charset="utf-8">
 <head>
  <meta http-equiv="X-UA-COMPATIBLE" content="IE=EmulateIE9">
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Sushanth">
  <meta name="description" content="This Interactive Map Tells You Everything You Need to Know About the 2016 US Election">
  <link href="css/bootstrap.css" rel="stylesheet">    
  <link href="css/basic.css" rel="stylesheet">
  <link href="css/feature.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" media="screen" href="http://fortawesome.github.io/Font-Awesome/assets/font-awesome/css/font-awesome.css">
  <link rel="stylesheet" type="text/css" media="screen" href="http://netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css">
  <link href="css/custom-styles.css" rel="stylesheet">
  <link href="css/jquery-ui.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" media="screen" href="/./css/multiple-select.css">
  <link href="//cdn.datatables.net/1.10.9/css/jquery.dataTables.min.css" rel="stylesheet" />
  <link rel="shortcut icon" href="/./images/logo.png">
  <script type="text/javascript" src="js/jquery.min.js"></script>  
  <script type="text/javascript" src="js/d3.js"></script>
  <script type="text/javascript" src="js/sankey.js"></script>
  <script type="text/javascript" src="/./javascripts/google-analyitcs.js"></script> 
  <script type="text/javascript" src="/./javascripts/angular.min.js"></script>  
  <script type="text/javascript" src="js/bootstrap.min.js"></script>  
  <script type="text/javascript" src="js/underscore-min.js"></script>
  <script type="text/javascript" src="/./javascripts/jquery.multiple.select.js"></script>  
  <script type="text/javascript" src="js/jquery-ui-1.10.3.min.js" ></script>
  <script type="text/javascript" src="https://cdn.datatables.net/1.10.10/js/jquery.dataTables.min.js"></script>  
  <meta property="og:title"  content="US Elections 2016" /> 
  <meta property="og:url"   content="http://data-analytics.github.io/Election_Data/tamil_nadu.html" /> 
  <meta itemprop="description" content="US Elections 2016 'A visual guide to the check out the history of US elections'">
  <meta property="og:image" content="images/images.png" /> 
  <html itemscope itemtype="http://schema.org/Blog">
  <meta itemprop="description" content="US Elections 2016 'A visual guide to the check out the history of US elections'">
  <meta itemprop="name" content="US Elections 2016">
  <meta itemprop="image" content="images/images.png">
  <title>US Elections 2016</title>
</head>
<body>

      <div class="container-fluid header-style">
        <div class="container">
            <div class="row">
                <div class="col-md-12 header-logo">
                    <p class="heading-part"><a class="fa fa-home fa-2" id="home" href="/./"></a>The U.S Election 2016</p>
                    <p class="synopsis">This interactive map will bring you minute-by-minute results, from the national standings down to individual candidates and constituencies.</p>
                    <p class="synopsis">It aims to make the swing or transfer of seats from the past to the current elections</p>
                </div>
            </div>
        </div>
    </div>


<div id="overall_view">
    <div class="container-fluid">
    <div class="container">
            <div class="row">
            <div class="col-md-12 panel panel-default">
            <div class="row">
                <div class="col-md-12 panel-heading1">
                    <h2>United States presidential election Overall Results 2012</h2>
                </div>    
           </div>
           <div class="row">           
                <div class=" col-md-12 panel-body">
	                <div class="row">
                    <div class="col-md-2"></div> 
                    <div class="col-md-8"> 
                     <div class="overall_view_report">  
                     </div>
                    </div>
                    <div class="col-md-2"></div> 
                    </div>
                </div>
            </div>
            </div>
            </div>
    </div>
    </div>
    </div>


<div id="detailConstituency">
    <div class="container-fluid detail_percent_display">
    <div class="container">
        <div class="row">
        <div class="col-md-12 panel panel-default">
        <div class="row">
            <div class="col-md-12 panel-heading1">
                <h2 class="details_constituency">United States presidential election Results 2012</h2>
            </div>    
        </div>
        <div class="row">           
            <div class=" col-md-12 panel-body">
            	 <p class="form-inline header_form" >
                    <label align="left" >Search:</label>
                    <input type="text" class="geo_search" placeholder="eg: Arizona">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <label value="year">based on 2012 : </label>
                    <select multiple="multiple" id="year_2012" class="select_year"></select>&nbsp;&nbsp;
                    <label value="year">based on 2016 : </label>
                    <select multiple="multiple" id="year_2016" class="select_year"></select>
                     <input type="button" value="submit" class="party_filter"></input> 
                  </p>
                 <div class="statesvg"></div>
            </div>
        </div>        
    	</div>
    	</div>
    </div>
    </div>
</div>    	
    <div id="sankeyFlow">
    <div class="container-fluid">
    <div class="container">
            <div class="row">
            <div class="col-md-12 panel panel-default">   
            <div class="row">
                <div class="col-md-12 panel-heading1">
                    <h2>Party Transitions Trend from 2012 to 2016</h2>
                </div>    
           </div>
           <div class="row">           
                <div class=" col-md-12 panel-body">
                    <div  class="sankey_chart">
                    </div>
                </div>
          </div>            
          </div>
          </div>
    </div>
    </div>
    </div>
    
<script src="uStates.js"></script>
<script>
color_map = {'Republican':'#E61B23','Democratic':'#55B0E6'}

d3.csv("overall_results.csv", function(data) {

  data_set = {}
  data.forEach(function(d) {
   data_set[d.statecode] ={party:d[2012],old_party:d[2016],State:d.State,Electorates:d.Electorates,color : color_map[d[2012]]} ;
   d.Electorates = parseInt(d.Electorates)
  });

	uStates.draw(".statesvg", data_set);

    var electorates_count = d3.nest()
              .key(function(d) { return d[2012]; })
              .rollup(function(v) { return d3.sum(v, function(e) { return e.Electorates;}) })
              .entries(data);


      electorates_count.sort(function(a, b) { return b.values - a.values; })

      heading_colors = []
      electorates_count.forEach(function(o) {
        heading_colors.push(color_map[o.key])
      })

      max_seats = d3.max(electorates_count, function(d) { return d.values; }); 


      lowresult_data  = d3.select('.overall_view_report')
                                         .selectAll('div')
                                        .data([electorates_count])
                                        .enter()
                                        .append("div")
                                        .append("table")
                                        .attr("class","table table-condensed party-summary")

                        lowresult_data.append('tbody')
                                .selectAll("tr")
                                .data(function(o) { return o }).enter()
                                .append("tr")
                                .selectAll("td")
                                    .data(function(d,l) { return [d.key,d.values,l+':'+(d.values*100/max_seats).toFixed(2)] }).enter()
                                    .append('td')
                                    .attr('class',function(d) { return d+'s'})
                                    .style("max-width",'10px')
                                    .style("font-size",'15px')
                                    .text(function(o,i) { return i<2? o:'' })
                                    .append('div')
                                    .attr('class',function(d,i) { return i<2? '':'progress'; })
                                    .append('div')
                                    .attr('class','progress-bar progress-bar-striped')
                                    .attr('role','progressbar')
                                    .attr('aria-valuenow','70')
                                    .attr('aria-valuemin','0')
                                    .attr('aria-valuemax','100')
                                    .style('background-color',function(d,i) { return i<2? '':heading_colors[parseInt(d.split(':')[0])]; })
                                    .style('width',function(d,i) { return i<2? '0%':d.split(':')[1]+'%'; });
                                   
            d3.selectAll('.removed_data').remove();                   

});

var margin = {top: 50, right: 20, bottom: 20, left: 20},
    width = 1200 - margin.left - margin.right,
    height = 600 - margin.top - margin.bottom;

var formatNumber = d3.format(",.0f"), 
    format = function(d) { return formatNumber(d); },
    color = d3.scale.category20b();
    
// append the svg canvas to the page
var svg = d3.select(".sankey_chart").append("svg")
    .attr("width", '100%')
    .attr("data-height", '0.5678')
    .attr("viewBox",'0 0 1200 600')
  .append("g")
    .attr("transform", 
          "translate(" + margin.left + "," + margin.top + ")");

// Set the sankey diagram properties
var sankey = d3.sankey()
    .nodeWidth(100)
    .nodePadding(3)
    .size([width, height]);

var path = sankey.link();

// load the data (using the timelyportfolio csv method)

d3.csv("overall_results.csv", function(error, data) {

  party_2011 = _.uniq(data, function(item, key, a) {  return item[2012]; });
  party_2016 = _.uniq(data, function(item, key, a) {  return item[2016]; });

 var select_box = d3.select('#year_2012')     
                .selectAll("option")
                    .data(party_2011.filter(function(d) { return d[2012]!='' })) 
                    .enter().append("option")
                    .attr("value", function (d) { return d[2012]; })
                    .attr("class","name")
                    .attr("selected","")
                    .text(function (d) { return d[2012]; });

 var select_box = d3.select('#year_2016')     
                .selectAll("option")
                    .data(party_2016.filter(function(d) { return d[2016]!='' }))
                    .enter().append("option")
                    .attr("value", function (d) { return d[2016]; })
                    .attr("class","name")
                    .attr("selected","")
                    .text(function (d) { return d[2016]; });

$(".select_year").multipleSelect({ placeholder: "Here is the placeholder" });

flowyear_detail = '2012_2016';

data.forEach(function (d) {
        d.source_year =d[flowyear_detail.substring(0, 4)]
        d.target_year =d[flowyear_detail.substring(5, 9)] 
        d.combined_year =d[flowyear_detail.substring(0, 4)]+'_'+d[flowyear_detail.substring(5, 9)] 
        });

        data = data.filter(function(d){return (d.source_year!='') & (d.target_year!='') })
        
        var data_Count = d3.nest()
              .key(function(d) { return d.combined_year; })
              .rollup(function(v) { return d3.sum(v, function(e) { return e.Electorates;}) })
              .entries(data);
      
  graph = {"nodes" : [], "links" : []};
    
    name_list = []
    data_Count.forEach(function (d) {

      graph.nodes.push({ "name": d.key.split("_")[0], "color": color_map[d.key.split("_")[0]] });
      graph.nodes.push({ "name": '_'+d.key.split("_")[1], "color": color_map[d.key.split("_")[1]] });

      graph.links.push({ "source": d.key.split("_")[0],
                         "target": '_'+d.key.split("_")[1],
                         "source_color": color_map[d.key.split("_")[0]],
                         "target_color": color_map[d.key.split("_")[1]],
                         "value": d.values });
     });
     
     // return only the distinct / unique nodes
     graph.nodes = d3.keys(d3.nest()
       .key(function (d) { return d.name; })
       .map(graph.nodes));
     
     // loop through each link replacing the text with its index from node
     graph.links.forEach(function (d, i) {
       graph.links[i].source = graph.nodes.indexOf(graph.links[i].source);
       graph.links[i].target = graph.nodes.indexOf(graph.links[i].target);
     });

     //now loop through each nodes to make nodes an array of objects
     // rather than an array of strings
     graph.nodes.forEach(function (d, i) {       
       graph.nodes[i] = { "name": d };
     });

  sankey
    .nodes(graph.nodes)
    .links(graph.links)
    .layout(32);

 svg.selectAll(".head")
      .data([flowyear_detail.substring(0, 4),flowyear_detail.substring(5, 9)])
    .enter().append("text")
      .attr("y", -4)
      .attr("font-size",21)
      .attr("x", function(d,p) { return p < 1 ?  50 : 1110 ; })
      .attr("fill", function(d,p) { return p > 0 ? "rgb(99, 99, 99)" : "rgb(99, 99, 99)"; })
      .attr("text-anchor", function(d,p) { return p <  1 ? 'middle' : 'middle'; })
      .text(function(d) { return d; });
     
// add in the links
  var link = svg.append("g").selectAll(".link")
      .data(graph.links)
    .enter().append("path")
      .attr("class", "link")
      .attr("d", path)
      .style("stroke-width", function(d) { return Math.max(1, d.dy); })
      .style("fill", function(d) { return d.target_color; })
      .style("stroke", function(d) { return d.target_color; })      
      .sort(function(a, b) { return b.dy - a.dy; })
      .attr("data-title",function(d) { return d.source.name == d.target.name.replace('_','') ?  d.source.name+' has retained '+format(d.value)+' seats'  : d.target.name.replace('_','') + " has got "+ format(d.value)+" seats from "+ d.source.name; });

// add in the nodes
  var node = svg.append("g").selectAll(".node")
      .data(graph.nodes)
    .enter().append("g")
      .attr("class", "node")
      .attr("transform", function(d) { 
          return "translate(" + d.x + "," + d.y + ")"; })
    .call(d3.behavior.drag()
      .origin(function(d) { return d; })
      .on("dragstart", function() { 
          this.parentNode.appendChild(this); })
      .on("drag", dragmove));
      
// add the rectangles for the nodes
  node.append("rect")
      .attr("height", function(d) { return d.dy; })
      .attr("width", sankey.nodeWidth())
     .style("fill", function(d) { return color_map[d.name.replace('_','')]; })
      .style("stroke", function(d) { return d3.rgb(color_map[d.name.replace('_','')]).darker(2); })
       .attr('data-title',function(d) { return d.name.replace('_','') + "\n" + format(d.value)+' Seats'; });
    
  node
    .append("text")
    .attr("y", function(d) { return (d.dy/2)-1; })
    .attr("x", sankey.nodeWidth()/2)
    .attr("text-anchor", "middle")
    .style("font-size", "15px")
    .attr("data-title", function(d) { return d.name.replace('_','')+' : '+format(d.value)+' seats'; })
    .style("fill", function(d) { return (parseInt(color_map[d.name.replace('_','')].replace('#', ''), 16) > 0xffffff / 2) ? '#000' : '#fff';})
    .text(function(d) { return d.dy>29 ?d.value:' '; });

  node
    .append("text")
    .attr("y", function(d) { return (d.dy/2)+12; })
    .attr("x", sankey.nodeWidth()/2)
    .attr("text-anchor", "middle")
    .style("font-size", "12px")
    .attr("data-title", function(d) { return d.name.replace('_','')+' : '+format(d.value)+' seats'; })
    .style("fill", function(d) { return (parseInt(color_map[d.name.replace('_','')].replace('#', ''), 16) > 0xffffff / 2) ? '#000' : '#fff';})
    .text(function(d) { return d.dy>29 ?d.name.replace('_',''):' '; });

  $("text").tooltip({container: '.sankey_chart', html: true, placement:'top'});      
  $("rect").tooltip({container: '.sankey_chart', html: true, placement:'top'});  
  $("path").tooltip({container: '.sankey_chart', html: true, placement:'top'});      

// add in the title for the nodes
  node.append("text")
      .attr("x", -6)
      .attr("y", function(d) { return d.dy / 2; })
      .attr("dy", ".35em")
      .attr("text-anchor", "end")
      .attr("transform", null)
      .text(function(d) { return d.name.replace('_',''); })
    .filter(function(d) { return d.x < width / 2; })
      .attr("x", 6 + sankey.nodeWidth())
      .attr("text-anchor", "start");

// the function for moving the nodes
  function dragmove(d) {
    d3.select(this).attr("transform", 
        "translate(" + d.x + "," + (
                d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))
            ) + ")");
    sankey.relayout();
    link.attr("d", path);
  }
  
}); 
</script>
</body>
</html>