<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>

<head>

    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="d3.layout.cloud.js"></script>

    <style>
        html,body{

            min-height: 100%;
            height: 100%;

        }
    </style>


</head>

<body>

</body>

<script type="text/javascript">

    $(document).ready(function() {

        var layout, fill, words, w, h;
        var step = 1;

        load();

        var reloadintervall = setInterval(function(){

            load();

            // Stop Reloading after 100 Words
            if(step>=100){
                clearInterval(reloadintervall);
            }

        }, 600);


        var rtime;
        var timeout = false;
        var delta = 1000;
        $(window).resize(function() {
            rtime = new Date();
            if (timeout === false) {
                timeout = true;
                setTimeout(resizeend, delta);
            }
        });

        function resizeend() {
            if (new Date() - rtime < delta) {
                setTimeout(resizeend, delta);
            } else {
                timeout = false;
                load();
            }
        }

        // Load Dummy Words from server

        function load() {

            $.ajax({
                type: "GET",
                url: "sample_"+step+".json",
//                data: 'step='+step,
                cache: false,
                dataType: "json",
                success: function (words) {

                d3.select('body').selectAll("svg").remove();

                    step++;
                    step++;
 
                    w = $('body').width();
                    h = $('body').height();

                    var fontSizeScale = d3.scale.pow().exponent(5).domain([0,1]).range([10, 100]); // Racheli
                    var maxSize = d3.max(words, function (d) {return d.size;}); // Racheli

/*                    fill = d3.scale.category20();
*/
					fill = d3.scale.linear()
						.range(['#FCEB74','#EC7D1D'])
						.domain([0,100]);
	                
					
                    layout = d3.layout.cloud()
                        .size([w, h])
                        .startPoint([w/2.0, h/2.0])
                        .words(words)
                        .padding(5)
                        .rotate(function () {
                            return 0.5;
                        })
                        .fontSize(function (d) {return fontSizeScale(d.size/maxSize);}) // Racheli
                        .on("end", draw);

                    layout.start();

                }
            });

        }

        function draw(words) {

            // Racheli Start
            var X0 = d3.min( words, function (d) {
                    return d.x - (d.width/2);
                }),
                X1 = d3.max( words, function (d) {
                    return d.x + (d.width/2);
                });

            var Y0 = d3.min( words, function (d) {
                    return d.y - (d.height/2);
                }),
                Y1 = d3.max( words, function (d) {
                    return d.y + (d.height/2);
                });

            var scaleX = (X1 - X0) / (w);
            var scaleY = (Y1 - Y0) / (h);

            var scale = 1 / Math.max(scaleX, scaleY);

            var translateX = Math.abs(X0) * scale;
            var translateY = Math.abs(Y0) * scale;
            // Racheli End

            d3.select("body").append("svg")
                 .attr("viewBox", "0 0 "+layout.size()[0]+" "+layout.size()[1])
                .append("g")
                .attr("transform", "translate(" + layout.size()[0] / 2 + "," + layout.size()[1] / 2 + ")" + " scale(" + scale + ")") // standard
          //      .attr("transform", "translate(" + translateX + "," + translateY + ")" + " scale(" + scale + ")") // Racheli
                .selectAll("text")
                .data(words)
                .enter()
				.append("text")
                .style("font-family", "Serif")
                .style("fill", function (d, i) {
                    return fill(d.size);
                })
                .attr("text-anchor", "middle")
                .text(function (d) {
                    return d.text;
                })
				//.transition()
                //.duration(30)
				.style("font-size", function (d) {
                    return (d.size) + "px";
                })
				.attr("transform", function (d) {
                    return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
                });
        }

    });

</script>
</html>