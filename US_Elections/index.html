<!DOCTYPE html>
<!--------------------------------------------------------------
 Name:        data-analytics.github.io
 Purpose:     Data visualisation and analytics examples 
 Author:      sushanth
 Created:     28-01-2016
 Modified:    07-09-2016
 Copyright:  (c) sushanth 2016
 Licence:     protected
---------------------------------------------------------------->
<head>
<meta http-equiv="X-UA-COMPATIBLE" content="IE=EmulateIE9">
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<meta name="author" content="Sushanth">
<link href="css/bootstrap.css" rel="stylesheet">    
<link href="css/basic.css" rel="stylesheet">
<link href="css/feature.css" rel="stylesheet">
<link href="css/custom-styles.css" rel="stylesheet">
<link href="css/jquery-ui.css" rel="stylesheet">
<script type="text/javascript" src="js/jquery.min.js"></script>  
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/topojson.v1.min.js"></script>
<script type="text/javascript" src="/./javascripts/google-analyitcs.js"></script> 
<script type="text/javascript" src="/./javascripts/angular.min.js"></script>  
<script type="text/javascript" src="js/bootstrap.min.js"></script>  
<script type="text/javascript" src="js/underscore-min.js"></script>  
<script type="text/javascript" src="js/jquery-ui-1.10.3.min.js" ></script>
<title>United States presidential election, 2012 Results</title>
<style>
.counties{
  fill:#666;
  stroke: #444;
  stroke-width:0.3;
}


.counties .active {
  stroke-width: 2;
  stroke: #000;
   
}

.states {
  fill: none;
  stroke: #666;
  stroke-linejoin: round;
}

.background {
  fill: none;
  pointer-events: all;
}

</style>
</head>
<body>
      <div class="container-fluid header-style">
        <div class="container">
            <div class="row">
                <div class="col-md-12 header-logo">
                    
                    <p class="heading-part"><a class="fa fa-home fa-2" id="home" href="/./"></a>United States presidential election, 2012 Results, 'A visual guide to the check out the trends of 2012 results</p>
                    <p class="synopsis">This interactive map will bring you minute-by-minute results, from the national standings down to individual candidates and constituencies.Our Analytics And Advanced Visualization helps to bring in-depth Analysis.</p>
                                    
                <p align="center"><span class='st_facebook_hcount' displayText='Facebook'></span>
                <span class='st_twitter_hcount' displayText='Tweet'></span>
                <span class='st_linkedin_hcount' displayText='LinkedIn'></span>
                <span class='st_googleplus_hcount' displayText='Google'></span>
                <span class='st_email_hcount' displayText='Email'></span></p>
                
                </div>
                
            </div>
        </div>
    </div>
     <div class="container-fluid">
    <div class="container">
            <div class="row">
            <div class="col-md-12 panel panel-default">
            <div class="row">
                <div class="col-md-12 panel-heading1">
                    <h2>United States presidential election, 2012 Results</h2>
                </div>    
           </div>
           <div class="row">           
                <div class=" col-md-12 panel-body">
                    <p class="form-inline header_form" >
                        <label align="left" >Search:</label>
                        <input type="text" class="geo_search" placeholder="eg: Los Angeles">
                      </p>
                     <div class="geo_map"></div>
                </div>
            </div>
            </div>
            </div>
    </div>
    </div>
     <div class="container-fluid">
    <div class="container">
            <div class="row">
            <div class="col-md-12 panel panel-default">
            <div class="row">
                <div class="col-md-12 panel-heading1">
                    <h2>Detail View</h2>
                </div>    
           </div>
           <div class="row">           
                <div class=" col-md-12 panel-body">
                    <div class="table_view"></div>
                </div>
            </div>
            </div>
            </div>
    </div>
    </div>    
<script>

var width = 960,
    height = 600,
    centered;

var svg = d3.select(".geo_map").append("svg")
            .style("width", "100%")
            .attr("data-height","0.54")
            .attr("viewBox","0 0 "+width+" "+height);

var rateById = d3.map();

var quantize = d3.scaleQuantize()
    .domain([0, 0.15])
    .range(d3.range(9).map(function(i) { return "q" + i + "-9"; }));

var projection = d3.geoAlbers()
    .scale(1280)
    .translate([width / 2, height / 2]);

var path = d3.geoPath()
    .projection(projection);

svg.append("rect")
    .attr("class", "background")
    .attr("width", width)
    .attr("height", height)
    .on("click", clicked);

var g = svg.append("g");

party_color = {};
party_State = {};
party_votes = {};
party_county = {};
party_percent = {};
winning_party = {};

function addThousandsSeparator(t){var a=t;if(parseFloat(t)){t=new String(t);var e=t.split(".");e[0]=e[0].split("").reverse().join("").replace(/(\d{3})(?!$)/g,"$1,").split("").reverse().join(""),a=e.join(".")}return a}

d3.csv("us_county_full_data_rank.csv", function(us1) {

    us1 = us1.filter(function(d){return d.rank==1 })
    
color_map = {'GOP':'#E61B23','Dem':'#55B0E6'}

   county_list = [];
   us1.forEach(function (d) {
   
        party_color[d['FIPS Code']] = color_map[d.Party]
        party_State[d['FIPS Code']]    = d['State']
        party_votes[d['FIPS Code']] = d['Votes']
        party_county[d['FIPS Code']]    = d['County Name']
        party_percent[d['FIPS Code']] = (d['Votes']*100/d['TOTAL VOTES CAST']).toFixed(2);
        winning_party[d['FIPS Code']] = d.Party
        
        county_list.push(d['County Name']+', '+d['State']);
        
        }); 

d3.queue()
    .defer(d3.json, "us_counties.json")
    .defer(d3.csv, "us_county_full_data_rank.csv", function(d) { rateById.set(d.FIPS, d.FIPS); })
    .await(ready);
     
function ready(error, us) {
  if (error) throw error;

  g.append("g")
       .attr("class", "counties")
       .selectAll("path")
      .data(topojson.feature(us, us.objects.counties).features)
    .enter().append("path")
    .attr("class", function(d) { return d.id })
      .attr("fill", function(d) { return party_color[d.id]; })
      .attr("data-title", function(d) { return 'State : '+party_State[d.id]+'<br/> county : '+party_county[d.id]+'<br/> party : '+winning_party[d.id]+'<br/> votes : '+addThousandsSeparator(party_votes[d.id])+'<br/> votes(%) : '+party_percent[d.id] })
      .attr("sub_link",function(d) { return party_county[d.id]+', '+party_State[d.id] ;})
      .attr("d", path) 
      .on("click", clicked);

  g.append("path")
      .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
      .attr("class", "states")
      .attr("d", path);
      
  $("path").tooltip({container: '.geo_map', html: true, placement:'top'}); 

  var lastsearch = '';
    var $box = {};
    
    function add_search(search, chart) {
      var $chart = $(chart);
      $(search).on('keypress, change, keyup', function() {
        var search = $(this).val();
        if (lastsearch != search) {
          lastsearch = search;
          var re = new RegExp( "^" + search, "i" );
          $('path', $chart).each(function(){
              $(this).css('fill-opacity', re.test($(this).attr("sub_link")) ? '1.0': '0.1');
          });
        }
      });
    }

   add_search('.geo_search', '.geo_map');

    $( ".geo_search" ).autocomplete({
    minLength: 2, 
    source: function(req, responseFn) {
        var re = $.ui.autocomplete.escapeRegex(req.term);
        var matcher = new RegExp( "^" + re, "i" );
        var a = $.grep( county_list, function(item,index){
            return matcher.test(item);
        });
        responseFn( a );
    }
    });
    
}
});

function clicked(d) {
  
  d3.csv('us_county_full_data_rank.csv',function(data){

    sub_data = data.filter(function(o){ return o['FIPS Code']==d['id'] });
  

  function tabulate(data, columns) {

    d3.select('.table_view').select('table').remove();
    
    var table = d3.select('.table_view').append('table').attr('class','table')
    var thead = table.append('thead')
    var tbody = table.append('tbody');

    // append the header row
    thead.append('tr')
      .selectAll('th')
      .data(columns).enter()
      .append('th')
        .text(function (column) { return column; });

    // create a row for each object in the data
    var rows = tbody.selectAll('tr')
      .data(data)
      .enter()
      .append('tr');

    // create a cell in each row for each column
    var cells = rows.selectAll('td')
      .data(function (row) {
        return columns.map(function (column) {
          return {column: column, value: row[column]};
        });
      })
      .enter()
      .append('td')
        .text(function (d) { return d.value; });

    return table;
  }

  // render the table(s)
  tabulate(sub_data, ['State','County Name', 'Party','Votes','FIPS Code','rank']); // 2 column table

  });
  _
  
  var x, y, k;

  if (d && centered !== d) {
    var centroid = path.centroid(d);
    x = centroid[0];
    y = centroid[1];
    k = 4;
    centered = d;
  } else {
    x = width / 2;
    y = height / 2;
    k = 1;
    centered = null;
  }

  g.selectAll("path")
      .classed("active", centered && function(d) { return d === centered; });

  g.transition()
      .duration(750)
      .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
      .style("stroke-width", 1.5 / k + "px");
}

</script>
</body>
</html>